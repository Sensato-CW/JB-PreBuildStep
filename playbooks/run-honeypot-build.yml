---
- name: Honeypot â€“ Run Local Build Script
  hosts: all
  become: true
  gather_facts: false

  tasks:

    - name: Ensure HoneypotBuildScripts exists
      stat:
        path: /opt/HoneypotBuildScripts
      register: sentinel_dir

    - name: Fail if HoneypotBuildScripts missing
      fail:
        msg: "HoneypotBuildScripts directory not found. Run prebuild first."
      when: not sentinel_dir.stat.exists

    # Get GitHub username from token (runs on AWX controller)
    - name: Derive GitHub username from token
      uri:
        url: https://api.github.com/user
        method: GET
        headers:
          Authorization: "Bearer {{ lookup('env', 'GITHUB_TOKEN') }}"
        return_content: true
      register: github_response
      delegate_to: localhost

    - name: Set GitHub username fact
      set_fact:
        github_user: "{{ github_response.json.login }}"

    - name: Execute Honeypot build script
      shell: /bin/bash /opt/HoneypotBuildScripts/hp-build.sh
      environment:
        GITHUB_TOKEN: "{{ lookup('env', 'GITHUB_TOKEN') }}"
        GITHUB_USER: "{{ github_user }}"
      register: build_result

    - name: Show build output
      debug:
        var: build_result.stdout_lines

    - name: Fail if build failed
      fail:
        msg: "Honeypot build failed."
      when: build_result.rc != 0
