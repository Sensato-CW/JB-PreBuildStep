---
- name: Sentinel â€“ Credential Injection Test
  hosts: all
  gather_facts: false
  become: true

  tasks:

    - name: Test if github_token variable is defined
      debug:
        msg: >
          github_token variable is {{
            'DEFINED' if (github_token is defined) else 'NOT_DEFINED'
          }}

    - name: Test raw github_token value length
      debug:
        msg: >
          github_token length is {{
            (github_token | length) if (github_token is defined) else 'N/A'
          }}

    - name: Test if GITHUB_TOKEN exists in environment (without sudo preserve)
      shell: |
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "ENV_TOKEN_MISSING"
        else
          echo "ENV_TOKEN_PRESENT"
        fi
      register: env_test

    - name: Show environment test result
      debug:
        var: env_test.stdout

    - name: Test if GITHUB_TOKEN exists with sudo preserve
      shell: |
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "ENV_TOKEN_MISSING"
        else
          echo "ENV_TOKEN_PRESENT"
        fi
      become: true
      become_flags: "--preserve-env=GITHUB_TOKEN"
      register: sudo_env_test

    - name: Show sudo environment test result
      debug:
        var: sudo_env_test.stdout
