- name: Sentinel â€“ Run JB PreBuild Step
  hosts: sentinels_canary
  become: true
  gather_facts: false

  vars:
    marker_file: /etc/cloudwave/sentinel_prebuild_complete

  tasks:
    - name: Check if prebuild already completed
      stat:
        path: "{{ marker_file }}"
      register: prebuild_done

    - name: Download and run JB prebuild script
      shell: |
        set -euo pipefail

        wget -q -O /root/get_it.sh \
          https://raw.githubusercontent.com/Sensato-CW/JB-PreBuildStep/main/get_it.sh

        chmod +x /root/get_it.sh
        bash /root/get_it.sh

        mkdir -p /etc/cloudwave
        touch "{{ marker_file }}"
      args:
        executable: /bin/bash
      environment:
        GITHUB_TOKEN: "{{ github_token }}"
      when: not prebuild_done.stat.exists
