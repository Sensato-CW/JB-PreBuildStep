---
- name: Sentinel â€“ Run JB PreBuild Step
  hosts: all
  gather_facts: false
  become: true

  vars:
    marker_file: /etc/cloudwave/sentinel_prebuild_complete

  tasks:

    - name: Ensure marker directory exists
      file:
        path: /etc/cloudwave
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Check if prebuild already completed
      stat:
        path: "{{ marker_file }}"
      register: prebuild_done

    - name: Debug GITHUB_TOKEN presence (before sudo)
      shell: |
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "TOKEN_MISSING"
        else
          echo "TOKEN_PRESENT"
        fi
      register: token_check
      when: not prebuild_done.stat.exists

    - name: Show token injection result
      debug:
        var: token_check.stdout
      when: not prebuild_done.stat.exists

    - name: Fail if GITHUB_TOKEN is missing
      fail:
        msg: "GITHUB_TOKEN was not injected into environment."
      when:
        - not prebuild_done.stat.exists
        - token_check.stdout != "TOKEN_PRESENT"

    - name: Download JB prebuild script
      get_url:
        url: https://raw.githubusercontent.com/Sensato-CW/JB-PreBuildStep/main/get_it.sh
        dest: /root/get_it.sh
        mode: '0755'
      when: not prebuild_done.stat.exists

    - name: Execute JB prebuild script with preserved env
      shell: /bin/bash -x /root/get_it.sh
      register: prebuild_result
      become: true
      become_flags: "--preserve-env=GITHUB_TOKEN"
      when: not prebuild_done.stat.exists

    - name: Show script stdout
      debug:
        var: prebuild_result.stdout_lines
      when: not prebuild_done.stat.exists

    - name: Show script stderr
      debug:
        var: prebuild_result.stderr_lines
      when: not prebuild_done.stat.exists

    - name: Fail if prebuild script failed
      fail:
        msg: "Prebuild script failed with return code {{ prebuild_result.rc }}"
      when:
        - not prebuild_done.stat.exists
        - prebuild_result.rc != 0

    - name: Create completion marker
      file:
        path: "{{ marker_file }}"
        state: touch
        owner: root
        group: root
        mode: '0644'
      when: not prebuild_done.stat.exists

    - name: Confirm completion
      debug:
        msg: "Prebuild completed successfully."
      when: not prebuild_done.stat.exists
