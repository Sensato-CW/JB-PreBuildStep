---
- name: Sentinel â€“ Run JB PreBuild Step
  hosts: all
  become: true
  gather_facts: false

  vars:
    marker_file: /etc/cloudwave/sentinel_prebuild_complete

  tasks:

    - name: Ensure marker directory exists
      file:
        path: /etc/cloudwave
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Check if prebuild already completed
      stat:
        path: "{{ marker_file }}"
      register: prebuild_done

    - name: Download JB prebuild script
      get_url:
        url: https://raw.githubusercontent.com/Sensato-CW/JB-PreBuildStep/main/get_it.sh
        dest: /root/get_it.sh
        mode: '0755'
      when: not prebuild_done.stat.exists

    #################################################################
    # Run prebuild script asynchronously so SSH restarts don't kill job
    #################################################################

    - name: Execute JB prebuild script asynchronously
      shell: /bin/bash /root/get_it.sh
      async: 900
      poll: 0
      register: prebuild_job
      when: not prebuild_done.stat.exists

    - name: Wait for host to become reachable again
      wait_for_connection:
        delay: 15
        timeout: 600
      when: not prebuild_done.stat.exists

    #################################################################
    # Mark completion after host stabilizes
    #################################################################

    - name: Create completion marker
      file:
        path: "{{ marker_file }}"
        state: touch
        owner: root
        group: root
        mode: '0644'
      when: not prebuild_done.stat.exists

    - name: Display status if already completed
      debug:
        msg: "Prebuild already completed on this Sentinel."
      when: prebuild_done.stat.exists
