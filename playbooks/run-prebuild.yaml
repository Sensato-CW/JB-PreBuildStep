---
- name: Sentinel â€“ Clone Build Scripts (Prebuild Step)
  hosts: all
  gather_facts: false
  become: true

  vars:
    marker_file: /etc/cloudwave/sentinel_prebuild_complete
    # BUILD_OPTION selects which repo to clone:
    #   1 = SentinelBuildScripts
    #   2 = HoneypotBuildScripts
    #   3 = VScanBuildScripts
    #   4 = OrchestratorBuildScripts
    # Pass via AWX survey or extra vars: -e prebuild_option=2
    prebuild_option: "2"
    # GITHUB_TOKEN: pass via AWX credential env var or extra vars (-e gh_token=...)
    gh_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"

  tasks:

    - name: Validate prebuild_option is set
      fail:
        msg: "prebuild_option is required but not set."
      when: prebuild_option | length == 0

    - name: Validate gh_token is set
      fail:
        msg: "gh_token is required. Set GITHUB_TOKEN env var on AWX or pass -e gh_token=..."
      when: gh_token | length == 0

    - name: Ensure marker directory exists
      file:
        path: /etc/cloudwave
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Check if prebuild already completed
      stat:
        path: "{{ marker_file }}"
      register: prebuild_done

    - name: Download prebuild script
      get_url:
        url: https://raw.githubusercontent.com/Sensato-CW/JB-PreBuildStep/main/get_it.sh
        dest: /root/get_it.sh
        mode: '0755'
        force: true
      when: not prebuild_done.stat.exists

    - name: Execute prebuild script (non-interactive)
      shell: /bin/bash -x /root/get_it.sh
      environment:
        GITHUB_TOKEN: "{{ gh_token }}"
        BUILD_OPTION: "{{ prebuild_option }}"
      register: prebuild_result
      when: not prebuild_done.stat.exists

    - name: Show prebuild output
      debug:
        var: prebuild_result.stdout_lines
      when:
        - not prebuild_done.stat.exists
        - prebuild_result is defined

    - name: Fail if prebuild script failed
      fail:
        msg: "Prebuild script failed with return code {{ prebuild_result.rc }}"
      when:
        - not prebuild_done.stat.exists
        - prebuild_result.rc != 0

    - name: Create completion marker
      file:
        path: "{{ marker_file }}"
        state: touch
        owner: root
        group: root
        mode: '0644'
      when: not prebuild_done.stat.exists
